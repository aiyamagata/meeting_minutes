# セットアップガイド

## 📋 概要

このガイドでは、**GASのみで動作するシンプルな議事録自動生成ツール**のセットアップ方法を説明します。

**従来版（GAS + Python/Heroku）と比較して：**
- ✅ シンプル（1つのファイルのみ）
- ✅ エラーが少ない
- ✅ 管理が容易
- ✅ 無料で動作

## 🎯 前提条件

- Google Workspace アカウント
- Slack ワークスペース（Bot Token が必要）
- Google Drive の適切なアクセス権限
- （オプション）Gemini API Key（AI分類機能を使用する場合）

---

## 📝 セットアップ手順

### ステップ1: Google Apps Script プロジェクトの作成

1. [Google Apps Script](https://script.google.com/) にアクセス
2. 「新しいプロジェクト」をクリック
3. プロジェクト名を変更（例: `meeting-minutes-auto`）

### ステップ2: コードの配置

1. プロジェクトに `Code.gs` ファイルが表示されていることを確認
2. `gas/Code.gs` の内容をコピー
3. `Code.gs` の内容を全て削除し、コピーした内容を貼り付け
4. 保存（Ctrl+S または Cmd+S）

### ステップ3: 設定の確認と変更

`Code.gs` の先頭部分にある設定を確認・変更します：

```javascript
const CONFIG = {
  // 文字起こしファイルを保存するフォルダID
  TRANSCRIPT_FOLDER_ID: 'あなたのフォルダID',
  
  // 議事録ファイルの保存先フォルダID
  PROCESSED_FOLDER_ID: 'あなたのフォルダID',
  
  // 検索する日付範囲（過去N日）
  SEARCH_DAYS: 30,
  
  // 文字起こしファイルの命名パターン
  TRANSCRIPT_PATTERN: /Gemini によるメモ|文字起こし|transcript|meeting.*transcript/i
};
```

#### フォルダIDの取得方法

1. Google Driveでフォルダを開く
2. ブラウザのアドレスバーからIDを確認
   - URL例: `https://drive.google.com/drive/folders/1qHsTK30zKVl2bt2IhlXG79jCNW2IfUb_`
   - `1qHsTK30zKVl2bt2IhlXG79jCNW2IfUb_` の部分がフォルダID

### ステップ4: 参加者名マッピングの設定

`Code.gs` の中の `PARTICIPANT_MAPPING` を編集します：

```javascript
const PARTICIPANT_MAPPING = {
  'Co., Ltd OKAMOTO BROTHERS': '山形',
  'Creative Team ziek': '銅金',
  'R O': '竜',
  'Rico Yamazaki': 'リコ',
  'Tatsuya Okamoto': '龍允',
  'TAT': '龍允',
  'johnny leatherreport': 'ジョニー'
  // 必要に応じて追加
};
```

### ステップ5: Slack設定

#### Slack Bot Token の取得方法

1. **Slack APIにアクセス**
   - [Slack API](https://api.slack.com/apps) にアクセス
   - Slackアカウントでログイン

2. **新しいAppを作成**
   - 「Create New App」をクリック
   - 「From scratch」を選択
   - App名を入力（例: `Meeting Minutes Bot`）
   - ワークスペースを選択
   - 「Create App」をクリック

3. **Bot Token Scopesを設定**
   - 左側のメニューから「OAuth & Permissions」をクリック
   - 下にスクロールして「Scopes」セクションを表示
   - 「Bot Token Scopes」セクションで「Add an OAuth Scope」をクリック
   - 以下のスコープを追加：
     - `chat:write` - メッセージを投稿する権限

4. **ワークスペースにインストール**
   - ページ上部の「Install to Workspace」をクリック
   - 権限の確認画面が表示されるので、「許可する」をクリック
   - ワークスペースにBotがインストールされます

5. **Bot Tokenをコピー**
   - インストール後、「OAuth & Permissions」ページに戻る
   - 「Bot User OAuth Token」セクションに表示されるトークンをコピー
     - トークンは `xoxb-` で始まります
     - 例: `xoxb-xxxxxxxxxxxx-xxxxxxxxxxxxx-xxxxxxxxxxxxxxxxxxxxxxxx`

6. **GASのプロパティサービスに設定**
   - GASのエディタで「プロジェクトの設定」（歯車アイコン）をクリック
   - 「スクリプト プロパティ」セクションを開く
   - 「行を追加」をクリック
   - 以下を設定：
     - **プロパティ**: `SLACK_BOT_TOKEN`
     - **値**: コピーしたトークン（`xoxb-...`）
   - 「保存」をクリック

7. **オプション：投稿先チャンネルを設定**
   - 同じ「スクリプト プロパティ」で
   - もう1行追加：
     - **プロパティ**: `SLACK_CHANNEL`
     - **値**: `#議事録`（または投稿したいチャンネル名）
   - 「保存」をクリック

8. **Botをチャンネルに追加**
   - Slackで投稿先チャンネルを開く（例: `#議事録`）
   - チャンネル名をクリック
   - 「統合」タブを選択
   - 「アプリを追加」をクリック
   - 作成したBotを検索して追加

   または、チャンネルで以下のコマンドを実行：
   ```
   /invite @Bot名
   ```

**⚠️ 注意事項**
- Bot Tokenは機密情報です。GitHubにコミットしないでください
- Bot Tokenを共有しないでください
- トークンが漏洩した場合は、Slack APIで再生成してください

### ステップ6: Gemini API設定（オプション）

議事録の「まとめ」と「詳細」を「話した内容」と「決定事項」に正確に分類するため、Gemini APIを使用できます。

**注意**: Gemini API Keyが設定されていない場合、キーワードマッチング（従来の方法）に自動的にフォールバックします。

#### Gemini API Keyの取得方法

1. **Google AI Studioにアクセス**
   - https://aistudio.google.com/ にアクセス
   - Googleアカウントでログイン

2. **API Keyを生成**
   - 左側のメニューから「Get API key」をクリック
   - 「Create API key」をクリック
   - 新しいAPI Keyが生成されます
   - **重要**: API Keyをコピーして安全に保管してください

3. **GASにAPI Keyを設定**
   - Google Apps Scriptのエディタを開く
   - 「プロジェクトの設定」（歯車アイコン）をクリック
   - 「スクリプト プロパティ」タブを選択
   - 以下のプロパティを追加：
     - **プロパティ**: `GEMINI_API_KEY`
     - **値**: コピーしたAPI Key

#### 動作の仕組み

**Gemini API使用時（推奨）**
1. 「まとめ」と「詳細」の内容をGemini APIに送信
2. Geminiが内容を分析し、「話した内容」と「決定事項」に分類
3. 分類結果をJSON形式で返却
4. 議事録に反映

**キーワードマッチング時（フォールバック）**
- Gemini API Keyが設定されていない場合
- Gemini APIでエラーが発生した場合

上記の場合、以下のキーワードで判定します：
- **決定事項**: 「決定」「承認」「承認されました」「決定しました」を含む行
- **話した内容**: 上記キーワードを含まない行

**料金について**
- Gemini APIは無料枠があります（月60リクエスト/分）
- 通常の使用では無料枠内で十分です
- 詳細は [Google AI Studio](https://aistudio.google.com/) で確認してください

### ステップ7: 権限の承認

1. GASのエディタで関数 `testGetMeetingTranscripts` を選択
2. 「実行」ボタンをクリック
3. 「権限を確認」をクリック
4. 自分のGoogleアカウントを選択
5. 「詳細」→「[プロジェクト名]に移動（安全ではないページ）」をクリック
6. 権限を承認：
   - Google Drive へのアクセス
   - Google Docs へのアクセス

### ステップ8: テスト実行

1. `testGetMeetingTranscripts` 関数を実行
2. 実行ログを確認（「表示」→「ログ」）
3. エラーがないか確認

### ステップ9: 定期実行の設定（トリガー）

1. GASのエディタで「トリガー」アイコン（時計）をクリック
2. 「トリガーを追加」をクリック
3. 以下の設定でトリガーを作成：
   - **実行する関数**: `getMeetingTranscripts`
   - **イベントのソース**: `時間主導型`
   - **時間ベースのトリガー**: `時間ベースのタイマー`
   - **時間の間隔**: `1時間おき` または `6時間おき`
4. 「保存」をクリック

---

## 🔄 HerokuからGASのみ版への移行

### Herokuの課金を停止する方法

1. **Heroku Dashboardにアクセス**
   - [Heroku Dashboard](https://dashboard.heroku.com/) にログイン

2. **アプリケーションを選択**
   - 移行するアプリケーションをクリック

3. **Settings タブを開く**
   - アプリケーションの「Settings」タブをクリック

4. **Add-onを削除（もし使用している場合）** ⚠️ **アプリ削除の前に実施**
   
   **確認場所：**
   - アプリケーションの「Settings」タブ内
   - 「Installed add-ons」セクション（Settingsタブの中ほどに表示されます）
   
   **確認手順：**
   1. アプリケーションの「Settings」タブを開く
   2. ページを下にスクロール
   3. 「Installed add-ons」セクションを探す
   4. インストールされているAdd-onの一覧が表示されます
   
   **削除手順：**
   - 各Add-onの右側に「…」（三点リーダー）アイコンがあります
   - クリックして「Destroy add-on」を選択
   - 確認ダイアログで削除を実行
   
   **注意：**
   - 有料のAdd-onがある場合は、**必ず削除してください**（課金を停止するため）
   - 無料のAdd-onも不要であれば削除することを推奨します
   - Add-onを削除すると、そのAdd-onに関連するデータも失われます
   - **アプリを削除する前にAdd-onを削除することを推奨します**

5. **アプリケーションを削除**
   - Settingsタブの下にスクロールして「Delete app」セクションを表示
   - アプリ名を入力して「Delete」をクリック
   - **注意**: この操作は取り消せません。バックアップが必要な場合は事前に取得してください。

6. **課金状況を確認**
   - [Account Settings](https://dashboard.heroku.com/account/billing) で請求状況を確認
   - クレジットカード情報を削除したい場合は、[Payment Methods](https://dashboard.heroku.com/account/billing) から削除可能

**補足：**
- アプリを削除すると、そのアプリに関連する全てのデータが失われます
- 無料プランを使用している場合でも、念のためアプリを削除することを推奨します
- 課金が発生していない場合でも、不要なリソースは削除しておくことをおすすめします

### GASコードの上書き

**A: はい、可能です！**

**手順：**

1. **現在のCode.gsをバックアップ（推奨）**
   - GASエディタで現在のコードをコピーして保存
   - または、gitでコミットしておく

2. **Code.gsの内容で上書き**
   - `gas/Code.gs` の内容をコピー
   - GASエディタで `Code.gs` を開く
   - 全ての内容を削除して、`Code.gs` の内容を貼り付け
   - 保存（Ctrl+S / Cmd+S）

3. **設定を確認・変更**
   ```javascript
   const CONFIG = {
     TRANSCRIPT_FOLDER_ID: 'あなたのフォルダID',
     PROCESSED_FOLDER_ID: 'あなたのフォルダID',
     SEARCH_DAYS: 30,
     TRANSCRIPT_PATTERN: /Gemini によるメモ|文字起こし|transcript|meeting.*transcript/i
   };
   
   const PARTICIPANT_MAPPING = {
     'ニックネーム': '正式名',
     // ...
   };
   ```

4. **Slack設定を追加（まだの場合）**
   - 「プロジェクトの設定」→「スクリプト プロパティ」で追加：
     - `SLACK_BOT_TOKEN`: Slack Bot Token
     - `SLACK_CHANNEL`: 投稿先チャンネル（オプション）

5. **テスト実行**
   - `testGetMeetingTranscripts` 関数を実行
   - 実行ログでエラーがないか確認

**注意点：**
- 上書きすると、旧コードは失われます（バックアップ推奨）
- 設定値（フォルダID、参加者マッピング）は再設定が必要です
- トリガーは再設定する必要があるかもしれません

### 移行チェックリスト

現在の複雑な構造（GAS + Python/Heroku）から移行する場合：

- [ ] 新しいGASプロジェクトを作成（または既存のCode.gsを上書き）
- [ ] `gas/Code.gs` の内容をコピー
- [ ] 設定（フォルダID、参加者マッピング）を確認・変更
- [ ] Slack設定を追加
- [ ] （オプション）Gemini API Keyを設定
- [ ] 権限を承認
- [ ] テスト実行
- [ ] トリガーを設定
- [ ] 動作確認
- [ ] 旧システム（Heroku）を停止（オプション）

---

## 🔧 トラブルシューティング

### フォルダが見つからないエラー

- フォルダIDが正しいか確認
- GASを実行しているアカウントがフォルダにアクセス権限を持っているか確認

### ファイルが読み込めない

- ファイルがGoogle Document形式か確認
- ファイルのアクセス権限を確認
- Drive APIサービスが有効になっているか確認（GASの「サービス」から追加可能）

### Slackに投稿されない

- `SLACK_BOT_TOKEN` が正しく設定されているか確認
- Botがチャンネルに追加されているか確認（`/invite @bot名`）
- 実行ログでエラーメッセージを確認

### 処理済みファイルが再度処理される

- ファイルの説明欄に `PROCESSED:` が含まれているか確認
- 処理済みマークが正しく追加されているか確認

### Gemini APIが動作しない場合

1. **API Keyが正しく設定されているか確認**
   - GASの「スクリプト プロパティ」で`GEMINI_API_KEY`が設定されているか確認

2. **ログを確認**
   - GASの「実行ログ」でエラーメッセージを確認
   - 「キーワードマッチングにフォールバックします...」というメッセージが表示される場合は、Gemini APIが使用されていません

3. **フォールバック動作**
   - Gemini APIが使用できない場合でも、キーワードマッチングで動作します
   - 精度は下がりますが、基本的な分類は可能です

**注意事項**
- Gemini API Keyは機密情報です。他人に共有しないでください
- API Keyが漏洩した場合は、Google AI Studioで再生成してください
- 大量のリクエストを送信する場合は、レート制限に注意してください

## 📊 実行ログの確認

1. GASのエディタで「表示」→「ログ」をクリック
2. 実行時のログを確認
3. エラーがあれば、エラーメッセージを確認して対処

## 🔍 デバッグ機能

### ファイル検索のデバッグ

`debugListFiles` 関数を実行すると、検索対象のファイル一覧が表示されます。

## 📝 注意事項

1. **実行時間制限**
   - GASの通常のトリガーは6分でタイムアウト
   - 大量のファイルを処理する場合は、処理を分割する必要がある可能性があります

2. **同時実行の制限**
   - 同時実行できるスクリプト数に制限があります
   - トリガーの実行間隔を適切に設定してください

3. **参加者名マッピング**
   - 新しい参加者が追加された場合は、`PARTICIPANT_MAPPING` を更新してください

## 🎉 完了

これで、GASのみで動作するシンプルな議事録自動生成ツールが使用できます！

問題が発生した場合は、実行ログを確認してトラブルシューティングセクションを参照してください。

